#!/bin/bash

# –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
CLR_INFO='\033[1;97;44m'
CLR_SUCCESS='\033[1;30;42m'
CLR_WARNING='\033[1;37;41m'
CLR_ERROR='\033[1;31;40m'
CLR_RESET='\033[0m'
CLR_GREEN='\033[0;32m'

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
DILL_VERSION="v1.0.4"
DILL_DIR="$HOME/dill"
DILL_LINUX_AMD64_URL="https://dill-release.s3.ap-southeast-1.amazonaws.com/$DILL_VERSION/dill-$DILL_VERSION-linux-amd64.tar.gz"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞
function show_logo() {
    echo -e "${CLR_INFO}      –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–æ–¥–∞–º–∏ Dill      ${CLR_RESET}"
    curl -s https://raw.githubusercontent.com/profitnoders/Profit_Nodes/refs/heads/main/logo_new.sh | bash
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
function install_dependencies() {
    sudo apt update && sudo apt upgrade -y
    sudo apt install -y curl tar
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–æ–¥—ã
function install_node() {
    install_dependencies

    echo -e "${CLR_INFO}–°–∫–∞—á–∏–≤–∞–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Dill Node...${CLR_RESET}"
    mkdir -p "$DILL_DIR"
    cd "$DILL_DIR"

    curl -O "$DILL_LINUX_AMD64_URL"
    tar -zxvf "dill-$DILL_VERSION-linux-amd64.tar.gz"

    echo -e "${CLR_SUCCESS}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${CLR_RESET}"
    
    # –ó–∞–ø—É—Å–∫ –Ω–æ–¥—ã
    echo -e "${CLR_INFO}–ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–¥—É...${CLR_RESET}"
    bash "$DILL_DIR/1_launch_dill_node.sh"
}

# –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞
function add_validator() {
    echo -e "${CLR_INFO}–î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞...${CLR_RESET}"
    bash "$DILL_DIR/2_add_validator.sh"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
function view_logs() {
    echo -e "${CLR_INFO}–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Dill Node...${CLR_RESET}"
    journalctl -fu dill -n 50
}

# –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–æ–¥—ã
function remove_node() {
    echo -e "${CLR_WARNING}–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –Ω–æ–¥—É? (y/n)${CLR_RESET}"
    read -r confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        echo -e "${CLR_INFO}–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –Ω–æ–¥—É...${CLR_RESET}"
        sudo systemctl stop dill
        sudo systemctl disable dill
        rm -rf "$DILL_DIR"
        echo -e "${CLR_SUCCESS}–ù–æ–¥–∞ —É–¥–∞–ª–µ–Ω–∞!${CLR_RESET}"
    else
        echo -e "${CLR_WARNING}–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.${CLR_RESET}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –Ω–æ–¥—ã
function restart_node() {
    echo -e "${CLR_INFO}–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–¥—É...${CLR_RESET}"
    sudo systemctl restart dill
    echo -e "${CLR_SUCCESS}–ù–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞!${CLR_RESET}"
}

# –ú–µ–Ω—é
function show_menu() {
    show_logo
    echo -e "${CLR_GREEN}1) üöÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É${CLR_RESET}"
    echo -e "${CLR_GREEN}2) üèõ –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞${CLR_RESET}"
    echo -e "${CLR_GREEN}3) üìú –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤${CLR_RESET}"
    echo -e "${CLR_GREEN}4) üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É${CLR_RESET}"
    echo -e "${CLR_GREEN}5) üóë –£–¥–∞–ª–∏—Ç—å –Ω–æ–¥—É${CLR_RESET}"
    echo -e "${CLR_GREEN}6) ‚ùå –í—ã–π—Ç–∏${CLR_RESET}"
    read -r choice
    case $choice in
        1) install_node ;;
        2) add_validator ;;
        3) view_logs ;;
        4) restart_node ;;
        5) remove_node ;;
        6) exit 0 ;;
        *) show_menu ;;
    esac
}

show_menu
